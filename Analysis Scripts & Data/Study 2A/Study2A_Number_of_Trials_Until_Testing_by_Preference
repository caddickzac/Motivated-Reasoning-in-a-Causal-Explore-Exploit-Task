################################################
# Number of Trials Until Testing by Preference #
################################################

# Import Libraries
library("tidyverse")
library('lmerTest')

# Import data
Number_of_Trials_Until_Testing_by_Preference <- as_tibble(read.csv("Study2A_Number_of_Trials_Until_Testing_by_Preference.csv"))

# preview data
head(Number_of_Trials_Until_Testing_by_Preference)

# data dictionary:
## "Participant" = participant number
## "Function" = Function number (range 1-6; refer to payoff function figure)
## "Preferred_Policy_at_Start" = notes policy preference at start. 1 = randomized to preferred policy at start of learning task; 0 = non preferred policy at start; -88 = neutral policy (i.e., no opportunity for preference or not)
## "Trial_Number_of_First_Test" = Notes what trial number a participant made first test (i.e., change/switch) for a given policy/function; Note "NA"s mean a participant never tested a policy/function. Also note that trial 1-10 were learning trials, where a participant did not have control yet.

# Subtract 10 from trial number, to reflect trial # that participant actually had control of economic policies. 
Number_of_Trials_Until_Testing_by_Preference$first_test_adj <- 
  Number_of_Trials_Until_Testing_by_Preference$Trial_Number_of_First_Test - 10

# Descriptives: When did participants first test policies across randomized policy at start
# 1="Preferred policy at Start"
# 0="Non-preferred policy at start"
#-88="neutral policy at start" (i.e., no stance on either Policy A nor Policy B)
aggregate(Number_of_Trials_Until_Testing_by_Preference$first_test_adj, 
          by=list(Number_of_Trials_Until_Testing_by_Preference$Preferred_Policy_at_Start),
          mean, na.rm=T) %>% 
  rename("Preferred_Policy_at_Start" = "Group.1",
         "Mean_Trial_Number_of_First_Test" = "x")


# Re-scale to improve model convergence (z-score with min. value of 1)
Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered <- 
  scale(Number_of_Trials_Until_Testing_by_Preference$first_test_adj, center=TRUE)
Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered_fixed <- 
  Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered + 
  abs(min(Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered,na.rm=T)) + 
  1

# Analysis 1: number of trials until testing: preferred vs non-preferred at start (omitted neutral policies)
Number_of_Trials_Until_Testing_by_Preference_omit_neutral <- Number_of_Trials_Until_Testing_by_Preference %>% 
  filter(!Preferred_Policy_at_Start==-88)

# Effects coding for analysis
Number_of_Trials_Until_Testing_by_Preference_omit_neutral$Preferred_Policy_at_Start_coded <-
  as.double(ifelse(Number_of_Trials_Until_Testing_by_Preference_omit_neutral$Preferred_Policy_at_Start==1, .5,
         ifelse(Number_of_Trials_Until_Testing_by_Preference_omit_neutral$Preferred_Policy_at_Start==0,-.5,"")))

# Model: preferred vs non-preferred at start
m1 <- glmer(first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded + (1+Preferred_Policy_at_Start_coded|Participant),
            data=Number_of_Trials_Until_Testing_by_Preference_omit_neutral, family=Gamma(link='inverse'))
summary(m1)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: Gamma  ( inverse )
# Formula: first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded +      (1 + Preferred_Policy_at_Start_coded | Participant)
# Data: Number_of_Trials_Until_Testing_by_Preference_omit_neutral
# 
# AIC      BIC   logLik deviance df.resid 
# 296.5    317.6   -142.2    284.5      244 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.1699 -0.2405 -0.0971  0.3521  3.3749 
# 
# Random effects:
#   Groups      Name                            Variance Std.Dev. Corr 
# Participant (Intercept)                     0.02046  0.1430        
# Preferred_Policy_at_Start_coded 0.06412  0.2532   -0.17
# Residual                                    0.08580  0.2929        
# Number of obs: 250, groups:  Participant, 88
# 
# Fixed effects:
#   Estimate Std. Error t value Pr(>|z|)    
# (Intercept)                      0.77066    0.02679   28.77  < 2e-16 ***
#   Preferred_Policy_at_Start_coded -0.31445    0.04808   -6.54 6.15e-11 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr)
# Prfrr_P__S_ -0.078


# analysis 2: strong versus neutral preferences


# recode preference at start with effects coding (neutral preferences at start vs strong preference at start) 
Number_of_Trials_Until_Testing_by_Preference$Preferred_Policy_at_Start_coded2 <- 
  ifelse(Number_of_Trials_Until_Testing_by_Preference$Preferred_Policy_at_Start==-88, .5, -.5)


# Model: strong vs neutral preference at start
m2 <- glmer(first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded2 + (1+Preferred_Policy_at_Start_coded2|Participant),
            data=Number_of_Trials_Until_Testing_by_Preference, family=Gamma(link='inverse'))
summary(m2)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: Gamma  ( inverse )
# Formula: first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded2 +      (1 + Preferred_Policy_at_Start_coded2 | Participant)
# Data: Number_of_Trials_Until_Testing_by_Preference
# 
# AIC      BIC   logLik deviance df.resid 
# 868.3    893.6   -428.2    856.3      498 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -1.6702 -0.4729 -0.2633  0.4060  3.8027 
# 
# Random effects:
#   Groups      Name                             Variance Std.Dev. Corr 
# Participant (Intercept)                      0.02043  0.1429        
# Preferred_Policy_at_Start_coded2 0.06301  0.2510   -0.04
# Residual                                     0.15355  0.3919        
# Number of obs: 504, groups:  Participant, 88
# 
# Fixed effects:
#   Estimate Std. Error t value Pr(>|z|)    
# (Intercept)                       0.72931    0.02532  28.810   <2e-16 ***
#   Preferred_Policy_at_Start_coded2 -0.00859    0.04378  -0.196    0.844    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr)
# Prfr_P__S_2 -0.044
