#############################################
# Function Identification: Causal Functions #
#############################################

#import libraries
library("tidyverse")
library("lmerTest")

# import data
Study2A_Function_Identification_Causal_Functions <- as_tibble(read.csv("Study2A_Function_Identification_Causal_Functions.csv"))

# Preview data
head(Study2A_Function_Identification_Causal_Functions)

# data dictionary:
## "Participant" = participant number
## "Function" = function number (causal functions only; range 1-4; refer to payoff function figure)
## "Ambiguity" = denotes ambiguity of function (low vs high)
## "Congruence" = denotes preference-congruence for a given policy/function, 1=yes, -1=no (i.e., is preferred policy actually the best policy)
## "Plot_Match_Scored" = denotes whether or not a participant correctly identified the plot/figure the corresponds to a given function (1=yes, 0=no) 


##################################################
# Preference-Congruence vs Incongruence Analysis #
##################################################

Study2A_Function_Identification_Causal_Functions_strong_preference <- Study2A_Function_Identification_Causal_Functions %>% 
  filter(Congruence != "Neutral") # omit neutral policies

# Effects coding for model
Study2A_Function_Identification_Causal_Functions_strong_preference$Ambiguity2 <-
  ifelse(Study2A_Function_Identification_Causal_Functions_strong_preference$Ambiguity=="Low",.5,-.5)

Study2A_Function_Identification_Causal_Functions_strong_preference$Congruence2 <-
  ifelse(Study2A_Function_Identification_Causal_Functions_strong_preference$Congruence=="Congruent",.5,-.5)

# Maximal Model
# m1 <- glmer(Plot_Match_Scored ~ Congruence2*Ambiguity2 + (1+Congruence2*Ambiguity2|Participant),
#             data=Study2A_Function_Identification_Causal_Functions_strong_preference, family="binomial")
# summary(m1)
# Error: number of observations (=176) < number of random effects (=352) for term (1 + Congruence2 * Ambiguity2 | Participant); the random-effects parameters are probably unidentifiable

# Model presented in paper
m2 <- glmer(Plot_Match_Scored ~ Congruence2*Ambiguity2 + (1+Congruence2*Ambiguity2||Participant),
            data=Study2A_Function_Identification_Causal_Functions_strong_preference, family="binomial")
summary(m2)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: binomial  ( logit )
# Formula: Plot_Match_Scored ~ Congruence2 * Ambiguity2 + (1 + Congruence2 *      Ambiguity2 || Participant)
# Data: Study2A_Function_Identification_Causal_Functions_strong_preference
# 
# AIC      BIC   logLik deviance df.resid 
# 200.6    226.0    -92.3    184.6      168 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -0.7794 -0.5285 -0.4045 -0.2225  3.1148 
# 
# Random effects:
#   Groups        Name                   Variance  Std.Dev. 
# Participant   (Intercept)            0.000e+00 0.000e+00
# Participant.1 Congruence2            0.000e+00 0.000e+00
# Participant.2 Ambiguity2             2.877e+00 1.696e+00
# Participant.3 Congruence2:Ambiguity2 1.017e-10 1.008e-05
# Number of obs: 176, groups:  Participant, 88
# 
# Fixed effects:
#   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)             -1.4407     0.2942  -4.898 9.69e-07 ***
#   Congruence2              0.8004     0.4428   1.808   0.0706 .  
# Ambiguity2               0.8905     0.4581   1.944   0.0519 .  
# Congruence2:Ambiguity2  -0.8053     0.8556  -0.941   0.3466    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr) Cngrn2 Ambgt2
# Congruence2 -0.334              
# Ambiguity2  -0.288  0.218       
# Cngrnc2:Am2  0.158 -0.250 -0.221


#-----------------------------------------------------------------------------------------

#########################################
# Strong vs Neutral Preference Analysis #
#########################################


# Effects Coding
Study2A_Function_Identification_Causal_Functions$Ambiguity2 <- 
  ifelse(Study2A_Function_Identification_Causal_Functions$Ambiguity=="Low", .5, -.5)
Study2A_Function_Identification_Causal_Functions$Preference_Strength <-
  ifelse(Study2A_Function_Identification_Causal_Functions$Congruence=="Neutral", .5,-.5)


# Failed models:
# # Maximal model
# m1 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2*Preference_Strength|Participant),
#             data=Study2A_Function_Identification_Causal_Functions, family='binomial')
# summary(m1)
# # Model failed to converge: degenerate  Hessian with 2 negative eigenvalues
# 
# m2 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2*Preference_Strength||Participant),
#             data=Study2A_Function_Identification_Causal_Functions, family='binomial')
# summary(m2)
# # Model failed to converge with max|grad| = 0.00856655 (tol = 0.001, component 1)
# 
# m3 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (0+Ambiguity2*Preference_Strength|Participant),
#             data=Study2A_Function_Identification_Causal_Functions, family='binomial')
# summary(m3)
# # Model failed to converge: degenerate  Hessian with 1 negative eigenvalues
# 
# m4 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2+Preference_Strength|Participant),
#             data=Study2A_Function_Identification_Causal_Functions, family='binomial')
# summary(m4)
# # Model failed to converge with max|grad| = 0.0430846 (tol = 0.001, component 1)

# Model presented in paper
m5 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2+Preference_Strength||Participant),
            data=Study2A_Function_Identification_Causal_Functions, family='binomial')
summary(m5)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: binomial  ( logit )
# Formula: as.factor(Plot_Match_Scored) ~ Ambiguity2 * Preference_Strength +      (1 + Ambiguity2 + Preference_Strength || Participant)
# Data: Study2A_Function_Identification_Causal_Functions
# 
# AIC      BIC   logLik deviance df.resid 
# 373.4    400.4   -179.7    359.4      345 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -0.6945 -0.5702 -0.4117 -0.3439  2.9081 
# 
# Random effects:
#   Groups        Name                Variance  Std.Dev. 
# Participant   (Intercept)         5.442e-08 0.0002333
# Participant.1 Ambiguity2          1.002e+00 1.0009354
# Participant.2 Preference_Strength 4.660e-06 0.0021586
# Number of obs: 352, groups:  Participant, 88
# 
# Fixed effects:
#   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)                     -1.3906     0.1647  -8.446  < 2e-16 ***
#   Ambiguity2                       0.8164     0.2965   2.754  0.00589 ** 
#   Preference_Strength             -0.2613     0.2807  -0.931  0.35181    
# Ambiguity2:Preference_Strength   0.1821     0.5523   0.330  0.74165    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr) Ambgt2 Prfr_S
# Ambiguity2  -0.237              
# Prfrnc_Strn  0.111 -0.038       
# Ambgty2:P_S -0.053  0.073 -0.208
