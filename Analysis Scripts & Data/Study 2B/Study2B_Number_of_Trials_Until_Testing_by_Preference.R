################################################
# Number of Trials Until Testing by Preference #
################################################

# Import Libraries
library("tidyverse")
library('lmerTest')

# Import data
Number_of_Trials_Until_Testing_by_Preference <- as_tibble(read.csv("Study2B_Number_of_Trials_Until_Testing_by_Preference.csv"))

# preview data
head(Number_of_Trials_Until_Testing_by_Preference)

# data dictionary:
## "Participant" = participant number
## "Function" = Function number (range 1-6; refer to payoff function figure)
## "Preferred_Policy_at_Start" = notes policy preference at start. 1 = randomized to preferred policy at start of learning task; 0 = non preferred policy at start; -88 = neutral policy (i.e., no opportunity for preference or not)
## "Trial_Number_of_First_Test" = Notes what trial number a participant made first test (i.e., change/switch) for a given policy/function; Note "NA"s mean a participant never tested a policy/function. Also note that trial 1-10 were learning trials, where a participant did not have control yet.

# Subtract 10 from trial number, to reflect trial # that participant actually had control of economic policies. 
Number_of_Trials_Until_Testing_by_Preference$first_test_adj <- 
  Number_of_Trials_Until_Testing_by_Preference$Trial_Number_of_First_Test - 10

# Descriptives: When did participants first test policies across randomized policy at start
# 1="Preferred policy at Start"
# 0="Non-preferred policy at start"
#-88="neutral policy at start" (i.e., no stance on either Policy A nor Policy B)
aggregate(Number_of_Trials_Until_Testing_by_Preference$first_test_adj, 
          by=list(Number_of_Trials_Until_Testing_by_Preference$Preferred_Policy_at_Start),
          mean, na.rm=T) %>% 
  rename("Preferred_Policy_at_Start" = "Group.1",
         "Mean_Trial_Number_of_First_Test" = "x")


# Re-scale to improve model convergence (z-score with min. value of 1)
Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered <- 
  scale(Number_of_Trials_Until_Testing_by_Preference$first_test_adj, center=TRUE)
Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered_fixed <- 
  Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered + 
  abs(min(Number_of_Trials_Until_Testing_by_Preference$first_test_adj_centered,na.rm=T)) + 
  1

# Analysis 1: number of trials until testing: preferred vs non-preferred at start (omitted neutral policies)
Number_of_Trials_Until_Testing_by_Preference_omit_neutral <- Number_of_Trials_Until_Testing_by_Preference %>% 
  filter(!Preferred_Policy_at_Start==-88)

# Effects coding for analysis
Number_of_Trials_Until_Testing_by_Preference_omit_neutral$Preferred_Policy_at_Start_coded <-
  as.double(ifelse(Number_of_Trials_Until_Testing_by_Preference_omit_neutral$Preferred_Policy_at_Start==1, .5,
                   ifelse(Number_of_Trials_Until_Testing_by_Preference_omit_neutral$Preferred_Policy_at_Start==0,-.5,"")))

# Model: preferred vs non-preferred at start
m1 <- glmer(first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded + (1+Preferred_Policy_at_Start_coded|Participant),
            data=Number_of_Trials_Until_Testing_by_Preference_omit_neutral, family=Gamma(link='inverse'))
summary(m1)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: Gamma  ( inverse )
# Formula: first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded +      (1 + Preferred_Policy_at_Start_coded | Participant)
# Data: Number_of_Trials_Until_Testing_by_Preference_omit_neutral
# 
# AIC      BIC   logLik deviance df.resid 
# 659.1    687.1   -323.5    647.1      775 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.6427 -0.2580 -0.1203  0.3853  4.0445 
# 
# Random effects:
#   Groups      Name                            Variance Std.Dev. Corr 
# Participant (Intercept)                     0.02534  0.1592        
# Preferred_Policy_at_Start_coded 0.06860  0.2619   -0.09
# Residual                                    0.06947  0.2636        
# Number of obs: 781, groups:  Participant, 276
# 
# Fixed effects:
#   Estimate Std. Error t value Pr(>|z|)    
# (Intercept)                      0.79706    0.01561  51.059   <2e-16 ***
#   Preferred_Policy_at_Start_coded -0.21197    0.02572  -8.242   <2e-16 ***
#   ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr)
# Prfrr_P__S_ 0.054 



# analysis 2: strong versus neutral preferences

# recode preference at start with effects coding (neutral preferences at start vs strong preference at start) 
Number_of_Trials_Until_Testing_by_Preference$Preferred_Policy_at_Start_coded2 <- 
  ifelse(Number_of_Trials_Until_Testing_by_Preference$Preferred_Policy_at_Start==-88, .5, -.5)


# Model: strong vs neutral preference at start
m2 <- glmer(first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded2 + (1+Preferred_Policy_at_Start_coded2|Participant),
            data=Number_of_Trials_Until_Testing_by_Preference, family=Gamma(link='inverse'))
summary(m2)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: Gamma  ( inverse )
# Formula: first_test_adj_centered_fixed ~ Preferred_Policy_at_Start_coded2 +      (1 + Preferred_Policy_at_Start_coded2 | Participant)
# Data: Number_of_Trials_Until_Testing_by_Preference
# 
# AIC      BIC   logLik deviance df.resid 
# 2254.4   2286.7  -1121.2   2242.4     1594 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -2.1836 -0.4400 -0.1727  0.3535  4.6816 
# 
# Random effects:
#   Groups      Name                             Variance Std.Dev. Corr
# Participant (Intercept)                      0.02337  0.1529       
# Preferred_Policy_at_Start_coded2 0.03171  0.1781   0.01
# Residual                                     0.12120  0.3481       
# Number of obs: 1600, groups:  Participant, 283
# 
# Fixed effects:
#   Estimate Std. Error t value Pr(>|z|)    
# (Intercept)                       0.760598   0.015343  49.573   <2e-16 ***
#   Preferred_Policy_at_Start_coded2 -0.009469   0.018432  -0.514    0.607    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr)
# Prfr_P__S_2 -0.001
