#############################################
# Function Identification: Causal Functions #
#############################################

#import libraries
library("tidyverse")
library("lmerTest")

# import data
Study2B_Function_Identification_Causal_Functions <- as_tibble(read.csv("Study2B_Function_Identification_Causal_Functions.csv"))

# Preview data
head(Study2B_Function_Identification_Causal_Functions)

# data dictionary:
## "Participant" = participant number
## "Function" = function number (causal functions only; range 1-4; refer to payoff function figure)
## "Ambiguity" = denotes ambiguity of function (low vs high)
## "Congruence" = denotes preference-congruence for a given policy/function, 1=yes, -1=no (i.e., is preferred policy actually the best policy)
## "Plot_Match_Scored" = denotes whether or not a participant correctly identified the plot/figure the corresponds to a given function (1=yes, 0=no) 


##################################################
# Preference-Congruence vs Incongruence Analysis #
##################################################

Study2B_Function_Identification_Causal_Functions_strong_preference <- Study2B_Function_Identification_Causal_Functions %>% 
  filter(Congruence != "Neutral") # omit neutral policies

# Effects coding for model
Study2B_Function_Identification_Causal_Functions_strong_preference$Ambiguity2 <-
  ifelse(Study2B_Function_Identification_Causal_Functions_strong_preference$Ambiguity=="Low",.5,-.5)

Study2B_Function_Identification_Causal_Functions_strong_preference$Congruence2 <-
  ifelse(Study2B_Function_Identification_Causal_Functions_strong_preference$Congruence=="Congruent",.5,-.5)

# Maximal Model
# m1 <- glmer(Plot_Match_Scored ~ Congruence2*Ambiguity2 + (1+Congruence2*Ambiguity2|Participant),
#             data=Study2B_Function_Identification_Causal_Functions_strong_preference, family="binomial")
# summary(m1)
# Error: number of observations (=176) < number of random effects (=352) for term (1 + Congruence2 * Ambiguity2 | Participant); the random-effects parameters are probably unidentifiable


m2 <- glmer(Plot_Match_Scored ~ Congruence2*Ambiguity2 + (1+Congruence2*Ambiguity2||Participant),
            data=Study2B_Function_Identification_Causal_Functions_strong_preference, family="binomial")
summary(m2)

# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: binomial  ( logit )
# Formula: Plot_Match_Scored ~ Congruence2 * Ambiguity2 + (1 + Congruence2 *      Ambiguity2 || Participant)
# Data: Study2B_Function_Identification_Causal_Functions_strong_preference
# 
# AIC      BIC   logLik deviance df.resid 
# 595.0    629.6   -289.5    579.0      547 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -0.7746 -0.4880 -0.4589 -0.3535  2.3979 
# 
# Random effects:
#   Groups        Name                   Variance  Std.Dev.
# Participant   (Intercept)            2.019e-01 0.449320
# Participant.1 Congruence2            6.385e-01 0.799069
# Participant.2 Ambiguity2             1.031e-06 0.001015
# Participant.3 Congruence2:Ambiguity2 1.230e-05 0.003507
# Number of obs: 555, groups:  Participant, 280
# 
# Fixed effects:
#   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)             -1.3608     0.1689  -8.056  7.9e-16 ***
#   Congruence2              0.6063     0.2300   2.636  0.00840 ** 
#   Ambiguity2               0.6649     0.2292   2.901  0.00372 ** 
#   Congruence2:Ambiguity2   0.1359     0.4454   0.305  0.76028    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr) Cngrn2 Ambgt2
# Congruence2 -0.204              
# Ambiguity2  -0.302  0.075       
# Cngrnc2:Am2 -0.032 -0.154 -0.100

#-----------------------------------------------------------------------------------------

#########################################
# Strong vs Neutral Preference Analysis #
#########################################


# Effects Coding
Study2B_Function_Identification_Causal_Functions$Ambiguity2 <- 
  ifelse(Study2B_Function_Identification_Causal_Functions$Ambiguity=="Low", .5, -.5)
Study2B_Function_Identification_Causal_Functions$Preference_Strength <-
  ifelse(Study2B_Function_Identification_Causal_Functions$Congruence=="Neutral", .5,-.5)


# Failed models:
# # Maximal model
# m1 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2*Preference_Strength|Participant),
#             data=Study2B_Function_Identification_Causal_Functions, family='binomial')
# summary(m1)
# convergence issues
# 
# m2 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2*Preference_Strength||Participant),
#             data=Study2B_Function_Identification_Causal_Functions, family='binomial')
# summary(m2)
# convergence issues
# 
# m3 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (0+Ambiguity2*Preference_Strength|Participant),
#             data=Study2B_Function_Identification_Causal_Functions, family='binomial')
# summary(m3)
# convergence issues
# 
# m4 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2+Preference_Strength|Participant),
#             data=Study2B_Function_Identification_Causal_Functions, family='binomial')
# summary(m4)
# # Model failed to converge with max|grad| = 0.0430846 (tol = 0.001, component 1)

# Model presented in paper
m5 <- glmer(as.factor(Plot_Match_Scored) ~ Ambiguity2*Preference_Strength + (1+Ambiguity2+Preference_Strength||Participant),
            data=Study2B_Function_Identification_Causal_Functions, family='binomial')
summary(m5)
# Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) ['glmerMod']
# Family: binomial  ( logit )
# Formula: as.factor(Plot_Match_Scored) ~ Ambiguity2 * Preference_Strength +      (1 + Ambiguity2 + Preference_Strength || Participant)
# Data: Study2B_Function_Identification_Causal_Functions
# 
# AIC      BIC   logLik deviance df.resid 
# 1142.3   1177.5   -564.1   1128.3     1125 
# 
# Scaled residuals: 
#   Min      1Q  Median      3Q     Max 
# -0.7039 -0.4637 -0.3941 -0.3402  2.3923 
# 
# Random effects:
#   Groups        Name                Variance Std.Dev.
# Participant   (Intercept)         0.1538   0.3922  
# Participant.1 Ambiguity2          0.6170   0.7855  
# Participant.2 Preference_Strength 1.1330   1.0644  
# Number of obs: 1132, groups:  Participant, 283
# 
# Fixed effects:
#   Estimate Std. Error z value Pr(>|z|)    
# (Intercept)                     -1.5528     0.1401 -11.085  < 2e-16 ***
#   Ambiguity2                       0.5722     0.1707   3.351 0.000805 ***
#   Preference_Strength             -0.2763     0.1725  -1.602 0.109133    
# Ambiguity2:Preference_Strength  -0.2513     0.3228  -0.779 0.436226    
# ---
#   Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#   (Intr) Ambgt2 Prfr_S
# Ambiguity2  -0.233              
# Prfrnc_Strn  0.054  0.024       
# Ambgty2:P_S  0.112  0.012 -0.117
