############################################
# Testing the Optimal Policy by Preference #
############################################

# Import Libraries
library("tidyverse")
library('lmerTest')

# Import data
Study3_Testing_the_Optimal_Policy_by_Preference <- as_tibble(read.csv("Study3_Testing_the_Optimal_Policy_by_Preference.csv"))

# Preview data
head(Study3_Testing_the_Optimal_Policy_by_Preference)

# data dictionary:
## "Participant" = participant number
## "Function_Exposure" = denotes if participant was assigned to function exposure treatment (see study 3 methods for details); 1=yes, 0=no
## "Trial" = trial number (range: 11-150; only includes trials which participant had control of policies decisions)
## "Optimal_Policy_Selected" = Notes whether optimal policy (i.e., the policy choice that yields maximum output over time; 1=yes, -1=no) 
## "Ambiguity" = Notes whether function ambiguity type (low or high)
## "Congruence" = Notes whether optimal policy choice was also participants preferred policy (1=yes; -1=no)

OP_Study3 <- Study3_Testing_the_Optimal_Policy_by_Preference %>%
  group_by(Participant, Function_Exposure, Ambiguity, Congruence) %>%
  summarize(mean_Optimal_Policy_Selected=mean(Optimal_Policy_Selected),
            n=n())

# use effects coding
OP_Study3$Function_Exposure2 <- ifelse(OP_Study3$Function_Exposure==1,.5,-.5)
OP_Study3$Ambiguity2 <- ifelse(OP_Study3$Ambiguity=="Low", .5, -.5)
OP_Study3$Congruence2 <- ifelse(OP_Study3$Congruence==1, .5, -.5)


# note: there were many convergence issues before settling on this model
m <- lmer(mean_Optimal_Policy_Selected ~ Congruence2*Ambiguity2*Function_Exposure2 +
              (0+Congruence2+Ambiguity2||Participant),
            data=OP_Study3)
summary(m)
# Linear mixed model fit by REML. t-tests use Satterthwaite's method ['lmerModLmerTest']
# Formula: mean_Optimal_Policy_Selected ~ Congruence2 * Ambiguity2 * Function_Exposure2 +      (0 + Congruence2 + Ambiguity2 || Participant)
#    Data: OP_Study3
# 
# REML criterion at convergence: 182.9
# 
# Scaled residuals: 
#      Min       1Q   Median       3Q      Max 
# -2.61219 -0.37576  0.02835  0.50855  2.53725 
# 
# Random effects:
#  Groups        Name        Variance Std.Dev.
#  Participant   Congruence2 0.04381  0.2093  
#  Participant.1 Ambiguity2  0.05605  0.2367  
#  Residual                  0.07727  0.2780  
# Number of obs: 300, groups:  Participant, 78
# 
# Fixed effects:
#                                            Estimate Std. Error        df t value Pr(>|t|)    
# (Intercept)                                 0.51192    0.01614 146.56306  31.715  < 2e-16 ***
# Congruence2                                 0.29500    0.04012  75.25274   7.353 1.98e-10 ***
# Ambiguity2                                  0.42427    0.04205  77.37437  10.090 9.26e-16 ***
# Function_Exposure2                         -0.01210    0.03228 146.56306  -0.375    0.708    
# Congruence2:Ambiguity2                     -0.05510    0.06456 146.60577  -0.854    0.395    
# Congruence2:Function_Exposure2             -0.02100    0.08024  75.25274  -0.262    0.794    
# Ambiguity2:Function_Exposure2              -0.06159    0.08410  77.37437  -0.732    0.466    
# Congruence2:Ambiguity2:Function_Exposure2   0.05932    0.12911 146.60577   0.459    0.647    
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#             (Intr) Cngrn2 Ambgt2 Fnc_E2 Cn2:A2 C2:F_E A2:F_E
# Congruence2 -0.019                                          
# Ambiguity2   0.001 -0.004                                   
# Fnctn_Exps2  0.049  0.004  0.013                            
# Cngrnc2:Am2 -0.011  0.002 -0.019 -0.008                     
# Cngrn2:F_E2  0.004  0.057 -0.008 -0.019  0.013              
# Ambgt2:F_E2  0.013 -0.008  0.058  0.001  0.004 -0.004       
# Cn2:A2:F_E2 -0.008  0.013  0.004 -0.011  0.049  0.002 -0.019
