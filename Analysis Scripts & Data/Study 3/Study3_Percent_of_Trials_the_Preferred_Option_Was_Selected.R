####################################################################
# Percent of Trials During which the Preferred Option Was Selected #
####################################################################

# Import Libary
library("tidyverse")
library('lsr') # used for "CohensD" function

# Import data
Study3_Amount_of_Testing_by_Preference <- read.csv('Study3_Percent_of_Trials_the_Preferred_Option_Was_Selected.csv')

# preview data
head(Study3_Amount_of_Testing_by_Preference)

# data dictionary: 
## "Participant" = participant number
## "Trial" = learning trial number (ranges: 0-151). Participants could only change input on trials 11-150 (1-10 were for learning purposes, and trial 151 was for final assessments of policies)
## "Function_Exposure_Treatment" = denotes whether or not participant received function exposure treatment (see Study 3 method section for details;), 0=no, 1=yes
##  "F1_Pref_Policy" = Notes whether or not Function 1 was set to a preferred policy (coded as 1) or not (coded as 0); -88 denotes no participant preference (neutral stance) 
##  "F2_Pref_Policy" = Notes whether or not Function 2 was set to a preferred policy (coded as 1) or not (coded as 0); -88 denotes no participant preference (neutral stance) 
##  "F3_Pref_Policy" = Notes whether or not Function 3 was set to a preferred policy (coded as 1) or not (coded as 0); -88 denotes no participant preference (neutral stance) 
##  "F4_Pref_Policy" = Notes whether or not Function 4 was set to a preferred policy (coded as 1) or not (coded as 0); -88 denotes no participant preference (neutral stance) 
##  "F5_Pref_Policy" = Notes whether or not Function 5 was set to a preferred policy (coded as 1) or not (coded as 0); -88 denotes no participant preference (neutral stance) 
##  "F6_Pref_Policy" = Notes whether or not Function 6 was set to a preferred policy (coded as 1) or not (coded as 0); -88 denotes no participant preference (neutral stance)

# Filter to only include trials where participants had control over policy choice (trials 1-150).  
Study3_Amount_of_Testing_by_Preference <- Study3_Amount_of_Testing_by_Preference %>% 
  filter(Trial %in% c(11:150))

# Create dataframe with percent of preferred policy for each function
Study3_Amount_of_Testing_by_Preference_Mean_Output <- Study3_Amount_of_Testing_by_Preference %>%
  group_by(Participant) %>% 
  summarise_at(.vars = vars(Function_Exposure_Treatment,
                            F1_Pref_Policy,
                            F2_Pref_Policy,
                            F3_Pref_Policy,
                            F4_Pref_Policy,
                            F5_Pref_Policy,
                            F6_Pref_Policy
  ),
  .funs= c(mean="mean"), na.rm=TRUE)

# Remove instances of neutral policies for every participant and all six functions (neural policies are coded as "-88")
Study3_Amount_of_Testing_by_Preference_Mean_Output$F1_Pref_Policy_mean_clean <- 
  ifelse(Study3_Amount_of_Testing_by_Preference_Mean_Output$F1_Pref_Policy_mean==-88,NA,
         Study3_Amount_of_Testing_by_Preference_Mean_Output$F1_Pref_Policy_mean)
Study3_Amount_of_Testing_by_Preference_Mean_Output$F2_Pref_Policy_mean_clean <- 
  ifelse(Study3_Amount_of_Testing_by_Preference_Mean_Output$F2_Pref_Policy_mean==-88,NA,
         Study3_Amount_of_Testing_by_Preference_Mean_Output$F2_Pref_Policy_mean)
Study3_Amount_of_Testing_by_Preference_Mean_Output$F3_Pref_Policy_mean_clean <- 
  ifelse(Study3_Amount_of_Testing_by_Preference_Mean_Output$F3_Pref_Policy_mean==-88,NA,
         Study3_Amount_of_Testing_by_Preference_Mean_Output$F3_Pref_Policy_mean)
Study3_Amount_of_Testing_by_Preference_Mean_Output$F4_Pref_Policy_mean_clean <- 
  ifelse(Study3_Amount_of_Testing_by_Preference_Mean_Output$F4_Pref_Policy_mean==-88,NA,
         Study3_Amount_of_Testing_by_Preference_Mean_Output$F4_Pref_Policy_mean)
Study3_Amount_of_Testing_by_Preference_Mean_Output$F5_Pref_Policy_mean_clean <- 
  ifelse(Study3_Amount_of_Testing_by_Preference_Mean_Output$F5_Pref_Policy_mean==-88,NA,
         Study3_Amount_of_Testing_by_Preference_Mean_Output$F5_Pref_Policy_mean)
Study3_Amount_of_Testing_by_Preference_Mean_Output$F6_Pref_Policy_mean_clean <- 
  ifelse(Study3_Amount_of_Testing_by_Preference_Mean_Output$F6_Pref_Policy_mean==-88,NA,
         Study3_Amount_of_Testing_by_Preference_Mean_Output$F6_Pref_Policy_mean)

# examine output
head(Study3_Amount_of_Testing_by_Preference_Mean_Output)

# functions for computing testing preference mean values for each participant (causal & non-causal functions analyzed separately)
compute_causal_function_testing_preference <- function(F1, F2, F3, F4){
  mean_output_array <- c()
  for (i in 1:length(F1)){
    participant_mean <- mean(c(F1[i][!is.na(F1[i])],
                               F2[i][!is.na(F2[i])],
                               F3[i][!is.na(F3[i])],
                               F4[i][!is.na(F4[i])]))
    mean_output_array <- append(mean_output_array, participant_mean, after = length(mean_output_array))
  }
  return(mean_output_array)
}

compute_non_causal_function_testing_preference <- function(F5, F6){
  mean_output_array <- c()
  for (i in 1:length(F5)){
    valid_input_count <- length(c(F5[i][!is.na(F5[i])],
                                  F6[i][!is.na(F6[i])]))
    participant_mean <- mean(c(F5[i][!is.na(F5[i])],
                               F6[i][!is.na(F6[i])]))
    participant_mean <- ifelse(valid_input_count==0,NA, participant_mean) # if participant had both non-causal functions with "neutral stances" than they submit a "NA" for this analysis
    mean_output_array <- append(mean_output_array, participant_mean, after = length(mean_output_array))
  }
  return(mean_output_array)
}

# compute causal mean testing preference
Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean <- 
  compute_causal_function_testing_preference(Study3_Amount_of_Testing_by_Preference_Mean_Output$F1_Pref_Policy_mean_clean,
                                             Study3_Amount_of_Testing_by_Preference_Mean_Output$F2_Pref_Policy_mean_clean,
                                             Study3_Amount_of_Testing_by_Preference_Mean_Output$F3_Pref_Policy_mean_clean,
                                             Study3_Amount_of_Testing_by_Preference_Mean_Output$F4_Pref_Policy_mean_clean)

# compute non-causal mean testing preference
Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean <- 
  compute_non_causal_function_testing_preference(Study3_Amount_of_Testing_by_Preference_Mean_Output$F5_Pref_Policy_mean_clean,
                                                 Study3_Amount_of_Testing_by_Preference_Mean_Output$F6_Pref_Policy_mean_clean)

#-----------------------------------------------------------------------------------------------

# Cohen's d  function (compute effect size)
## (input 1 is vector of data for group/condition 1)
## (input 2 is vector of data for group/condition 2)
cohens_d_function <- function(input_1, input_2){
  # Remove NA values if present
  input_1 <- input_1[!is.na(input_1)==TRUE] # drop 'NA' values
  input_2 <- input_2[!is.na(input_2)==TRUE] # drop 'NA' values
  
  # Parameters for cohen's d calculation
  mean_1 <- mean(input_1)
  mean_2 <- mean(input_2)
  sd_1 <- sd(input_1)
  sd_2 <- sd(input_2)
  n_1 <- length(input_1)
  n_2 <- length(input_2)
  a_level <- .05
  
  # Computations
  mean_diff <- mean_1 - mean_2
  pooled_sd_n <- ((n_1-1)*(sd_1**2)) + ((n_1-1)*(sd_2**2))
  pooled_sd_d <- ((n_1 + n_2) - 2)
  pooled_sd <- sqrt(pooled_sd_n/pooled_sd_d)
  cohens_d <- mean_diff / pooled_sd
  return(cohens_d)
}

#-----------------------------------------------------------------------------------------------

####################
# Causal Functions #
####################

# Causal Functions: Preferred vs non-preferred testing - Descriptives
round(mean(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean),4)*100 # Mean = 64.82   
round(sd(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean),4)*100 # Std dev = 17.79

# Causal Functions: Preferred vs non-preferred testing - one-sample t-test
t.test(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean, mu=.50) # t(77)=7.36, p < .001

# Causal Functions: Preferred vs non-preferred testing - Cohen's d (one-sample t-test)
cohensD(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean, mu=.50) # d = .83


# Causal Functions: Function Exposure vs no function exposure - Descriptives
## function exposure group
round(mean(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean
     [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==1]),4)*100 # Mean = 64.44
round(sd(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean
           [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==1]),4)*100 # std dev = 15.88
## not exposed to functions group
round(mean(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean
           [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==0]),4)*100 # Mean = 65.15
round(sd(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean
           [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==0]),4)*100 # std dev = 19.46

# Causal Functions: Function Exposure vs no function exposure - independent samples t-test
t.test(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean ~ 
         Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean) # t(75.84)=.18, p=.86

# Causal Functions: Function Exposure vs no function exposure - cohen's d (effect size)
cohens_d_function(Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean
                  [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==0],
                  Study3_Amount_of_Testing_by_Preference_Mean_Output$Causal_Pref_Policy_mean
                  [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==1]) # d = .04

#------------------------------------------------------------------------------------------------------------------------

########################
# Non-Causal Functions #
########################

# Non-Causal Functions: Preferred vs non-preferred testing - Descriptives
round(mean(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean, na.rm=TRUE),4)*100 # Mean = 68.32
round(sd(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean, na.rm=TRUE),4)*100 # Std dev = 24.23

# Non-Causal Functions: Preferred vs non-preferred testing - one-sample t-test
t.test(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean, mu=.50) # t(76)=6.63, p < .001

# Non-Causal Functions: Preferred vs non-preferred testing - Cohen's d
cohensD(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean, mu=.50) # d = .76


# Non-Causal Functions: Function Exposure vs no function exposure - Descriptives
## function exposure group
round(mean(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean
           [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==1],na.rm=T),4)*100 # Mean = 65.59
round(sd(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean
         [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==1],na.rm=T),4)*100 # std dev = 24.40
## not exposed to functions group
round(mean(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean
           [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==0],na.rm=T),4)*100 # Mean = 70.60
round(sd(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean
         [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==0],na.rm=T),4)*100 # std dev = 24.15

# Causal Functions: Function Exposure vs no function exposure - independent samples t-test
t.test(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean ~ 
         Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean) # t(72.25)=.90, p=.97

# Causal Functions: Function Exposure vs no function exposure - cohen's d (effect size)
cohens_d_function(Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean
                  [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==0],
                  Study3_Amount_of_Testing_by_Preference_Mean_Output$Non_Causal_Pref_Policy_mean
                  [Study3_Amount_of_Testing_by_Preference_Mean_Output$Function_Exposure_Treatment_mean==1]) # d = .20
